<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if URL has show_filters parameter and filters should be visible
    if (window.location.href.includes('show_filters=1') && window.location.hash === '#filters') {
        const filtersSection = document.getElementById('filters');
        if (filtersSection) {
            filtersSection.classList.remove('d-none');
        }
    }

    // Salary slider
    const salarySlider = document.getElementById('salary-slider');
    const salaryValue = document.getElementById('salary-value');
    
    if (salarySlider && salaryValue) {
        // Update display value while sliding
        salarySlider.addEventListener('input', function() {
            salaryValue.textContent = '₾ ' + salarySlider.value;
        });
        
        // Filter after slider stops (when user releases mouse)
        salarySlider.addEventListener('change', function() {
            applyFiltersWithAjax();
        });
    }
    
    // Auto-submit on select changes
    const filterSelects = document.querySelectorAll('select.filter-auto-submit');
    filterSelects.forEach(function(select) {
        select.addEventListener('change', function() {
            applyFiltersWithAjax();
        });
    });
    
    // Auto-submit on text input (with debounce)
    const searchInput = document.querySelector('input[name="search"]');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
                applyFiltersWithAjax();
            }, 500); // Wait 500ms after user stops typing
        });
    }
    
    // Auto-submit on checkbox changes
    const filterCheckboxes = document.querySelectorAll('.filter-auto-submit[type="checkbox"]');
    filterCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            applyFiltersWithAjax();
        });
    });
    
    // Variables to track AJAX state
    let currentRequest = null;
    
    // AJAX-based filtering to avoid page refreshes
    function applyFiltersWithAjax() {
        const form = document.getElementById('filter-form');
        if (!form) return;
        
        // Cancel any in-progress request
        if (currentRequest) {
            currentRequest.abort();
        }
        
        // Create form data object
        const formData = new FormData(form);
        const searchParams = new URLSearchParams();
        
        // Add all form values to search params
        for (const [key, value] of formData.entries()) {
            // Skip empty values
            if (value !== '' && key !== 'job_preferences') {
                searchParams.append(key, value);
            }
        }
        
        // Handle job preferences checkboxes (combine them)
        const checkedPreferences = [];
        form.querySelectorAll('input[name="job_preferences"]:checked').forEach(function(checkbox) {
            checkedPreferences.push(checkbox.value);
        });
        
        if (checkedPreferences.length > 0) {
            searchParams.append('job_preferences', checkedPreferences.join(','));
        }
        
        // Ensure the filters stay visible
        searchParams.append('show_filters', '1');
        searchParams.append('ajax', '1'); // Add indicator for AJAX request
        
        // Show a subtle loading indicator
        const contentContainer = document.querySelector('.container-fluid.px-6');
        if (contentContainer) {
            contentContainer.style.opacity = '0.6';
            contentContainer.style.transition = 'opacity 0.2s';
        }
        
        // Update URL without refreshing the page (for bookmarking and sharing)
        const newUrl = window.location.pathname + '?' + searchParams.toString() + (window.location.hash || '');
        window.history.pushState({ path: newUrl }, '', newUrl);
        
        // Make AJAX request
        currentRequest = new XMLHttpRequest();
        currentRequest.open('GET', '{% url "job_list" %}?' + searchParams.toString(), true);
        
        currentRequest.onload = function() {
            if (this.status >= 200 && this.status < 400) {
                // Success!
                const response = this.responseText;
                
                // Parse the HTML response
                const parser = new DOMParser();
                const doc = parser.parseFromString(response, 'text/html');
                
                // Update the job count in the heading
                updateJobCount(doc);
                
                // Update the active filters display
                updateActiveFilters(doc);
                
                // Replace the entire job listings container with the new content
                replaceJobListings(doc, contentContainer);
                
                // Update pagination if it exists
                updatePagination(doc);
                
                // Reattach event listeners for filter removal links
                attachFilterRemoveListeners();
                
                currentRequest = null;
            } else {
                // Error handler
                console.error('Server returned an error');
                if (contentContainer) {
                    contentContainer.style.opacity = '1';
                }
                currentRequest = null;
            }
        };
        
        currentRequest.onerror = function() {
            // Connection error
            console.error('Connection error');
            if (contentContainer) {
                contentContainer.style.opacity = '1';
            }
            currentRequest = null;
        };
        
        currentRequest.send();
    }
    
    // Function to update job count
    function updateJobCount(doc) {
        const resultCount = doc.querySelector('h2 small');
        if (resultCount) {
            const currentHeading = document.querySelector('h2');
            if (currentHeading) {
                const currentSmall = currentHeading.querySelector('small');
                if (currentSmall) {
                    currentSmall.textContent = resultCount.textContent;
                } else {
                    const newSmall = document.createElement('small');
                    newSmall.textContent = resultCount.textContent;
                    currentHeading.appendChild(newSmall);
                }
            }
        }
    }
    
    // Function to update active filters display
    function updateActiveFilters(doc) {
        const newActiveFilters = doc.querySelector('.active-filters');
        const currentActiveFilters = document.querySelector('.active-filters');
        
        if (newActiveFilters && currentActiveFilters) {
            currentActiveFilters.innerHTML = newActiveFilters.innerHTML;
        } else if (newActiveFilters) {
            // If active filters don't exist in current page but exist in response
            const filtersContainer = document.querySelector('.d-flex.justify-content-between.align-items-center.mb-4');
            if (filtersContainer) {
                const newActiveFiltersElement = document.createElement('div');
                newActiveFiltersElement.className = 'active-filters d-flex flex-wrap gap-2';
                newActiveFiltersElement.innerHTML = newActiveFilters.innerHTML;
                filtersContainer.appendChild(newActiveFiltersElement);
            }
        } else if (currentActiveFilters && !newActiveFilters) {
            // Remove active filters if they no longer exist in the response
            currentActiveFilters.remove();
        }
    }
    
    // Function to replace job listings
    function replaceJobListings(doc, contentContainer) {
        const newContentContainer = doc.querySelector('.container-fluid.px-6');
        
        if (newContentContainer && contentContainer) {
            // Replace the entire content container with animation
            contentContainer.innerHTML = newContentContainer.innerHTML;
            
            // Restore opacity with a slight delay for smooth transition
            setTimeout(function() {
                contentContainer.style.opacity = '1';
            }, 100);
            
            // Reattach event listeners to any new elements
            reattachEventListeners();
        }
    }
    
    // Function to update pagination
    function updatePagination(doc) {
        const newPagination = doc.querySelector('.d-flex.justify-content-center.mt-5');
        const currentPagination = document.querySelector('.d-flex.justify-content-center.mt-5');
        
        if (newPagination && currentPagination) {
            currentPagination.innerHTML = newPagination.innerHTML;
        } else if (newPagination) {
            // If pagination doesn't exist but should be added
            const contentParent = document.querySelector('.container-fluid.px-6').parentElement;
            contentParent.appendChild(newPagination.cloneNode(true));
        } else if (currentPagination) {
            // If pagination exists but should be removed
            currentPagination.remove();
        }
    }
    
    // Function to reattach event listeners after DOM updates
    function reattachEventListeners() {
        // Add hover effects to job cards
        const jobCards = document.querySelectorAll('.card.shadow-sm.h-100');
        jobCards.forEach(function(card) {
            card.addEventListener('mouseover', function() {
                this.style.transform = 'translateY(-5px)';
                this.style.boxShadow = '0 10px 20px rgba(0,0,0,0.1)';
            });
            
            card.addEventListener('mouseout', function() {
                this.style.transform = '';
                this.style.boxShadow = '';
            });
        });
    }
    
    // Function to attach event listeners to filter removal links
    function attachFilterRemoveListeners() {
        const filterRemoveLinks = document.querySelectorAll('.filter-remove-link');
        filterRemoveLinks.forEach(function(link) {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                const filterName = this.getAttribute('data-filter');
                const form = document.getElementById('filter-form');
                
                if (form) {
                    // Handle different filter types
                    switch(filterName) {
                        case 'საძიებო სიტყვა':
                            form.querySelector('input[name="search"]').value = '';
                            break;
                        case 'ლოკაცია':
                            form.querySelector('select[name="location"]').value = '';
                            break;
                        case 'კატეგორია':
                            form.querySelector('select[name="category"]').value = '';
                            break;
                        case 'გამოცდილება':
                            form.querySelector('select[name="experience"]').value = '';
                            break;
                        case 'Premium Level':
                            form.querySelector('select[name="premium_level"]').value = '';
                            break;
                        case 'მინიმალური ანაზღაურება':
                            const salarySlider = form.querySelector('input[name="salary_min"]');
                            if (salarySlider) {
                                salarySlider.value = 0;
                                const salaryValue = document.getElementById('salary-value');
                                if (salaryValue) {
                                    salaryValue.textContent = '₾ 0';
                                }
                            }
                            break;
                        case 'სამუშაოს ტიპი':
                            // Uncheck all job preference checkboxes
                            form.querySelectorAll('input[name="job_preferences"]:checked').forEach(function(checkbox) {
                                checkbox.checked = false;
                            });
                            break;
                        default:
                            break;
                    }
                    
                    // Apply filters with the removed filter
                    applyFiltersWithAjax();
                }
            });
        });
    }
    
    // Initial attachment of filter remove listeners
    attachFilterRemoveListeners();
    
    // Handle filter reset button without page refresh
    const resetButton = document.getElementById('reset-filters');
    if (resetButton) {
        resetButton.addEventListener('click', function(e) {
            e.preventDefault();
            // Reset all form fields
            const form = document.getElementById('filter-form');
            if (form) {
                form.reset();
                // Manually update the salary value display
                if (salaryValue && salarySlider) {
                    salarySlider.value = 0;
                    salaryValue.textContent = '₾ 0';
                }
                // Apply filters with empty values
                applyFiltersWithAjax();
            }
        });
    }
    
    // Handle pagination links without page refresh
    document.addEventListener('click', function(e) {
        // Check if the clicked element is a pagination link
        if (e.target.closest('.pagination a')) {
            e.preventDefault();
            const paginationLink = e.target.closest('.pagination a');
            const href = paginationLink.getAttribute('href');
            
            if (href && href !== '#') {
                // Extract the page number from the href
                const url = new URL(window.location.origin + window.location.pathname + href);
                const searchParams = url.searchParams;
                
                // Update the current URL
                window.history.pushState({ path: url.href }, '', url.href);
                
                // Load the new page via AJAX
                loadPageWithAjax(searchParams);
            }
        }
    });
    
    // Function to load a page with AJAX (for pagination)
    function loadPageWithAjax(searchParams) {
        // Cancel any in-progress request
        if (currentRequest) {
            currentRequest.abort();
        }
        
        // Add AJAX indicator
        searchParams.append('ajax', '1');
        
        // Show loading indicator
        const contentContainer = document.querySelector('.container-fluid.px-6');
        if (contentContainer) {
            contentContainer.style.opacity = '0.6';
            contentContainer.style.transition = 'opacity 0.2s';
        }
        
        // Make AJAX request
        currentRequest = new XMLHttpRequest();
        currentRequest.open('GET', '{% url "job_list" %}?' + searchParams.toString(), true);
        
        currentRequest.onload = function() {
            if (this.status >= 200 && this.status < 400) {
                // Parse the HTML response
                const parser = new DOMParser();
                const doc = parser.parseFromString(this.responseText, 'text/html');
                
                // Replace the job listings with the new content
                replaceJobListings(doc, contentContainer);
                
                // Update pagination
                updatePagination(doc);
                
                // Scroll to top of job listings
                window.scrollTo({
                    top: document.querySelector('.d-flex.justify-content-between.align-items-center.mb-4').offsetTop - 100,
                    behavior: 'smooth'
                });
                
                currentRequest = null;
            } else {
                console.error('Server returned an error');
                if (contentContainer) {
                    contentContainer.style.opacity = '1';
                }
                currentRequest = null;
            }
        };
        
        currentRequest.onerror = function() {
            console.error('Connection error');
            if (contentContainer) {
                contentContainer.style.opacity = '1';
            }
            currentRequest = null;
        };
        
        currentRequest.send();
    }
});
</script> 