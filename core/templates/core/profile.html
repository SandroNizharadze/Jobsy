{% extends 'core/base.html' %}
{% load i18n %}

{% block title %}{% trans "Linked AI - Your Profile" %}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 mb-0">{% trans "Your Profile" %}</h1>
    <div class="d-flex gap-2">
        {% if user.userprofile.role == 'employer' %}
            <a href="{% url 'employer_dashboard' %}" class="btn btn-linkedin">
                <i class="fas fa-building me-1"></i>{% trans "Employer Dashboard" %}
            </a>
        {% endif %}
        <a href="{% url 'job_list' %}" class="btn btn-outline-primary">
            <i class="fas fa-briefcase me-1"></i>{% trans "View Jobs" %}
        </a>
    </div>
</div>

<div class="profile-section">
    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
        {% csrf_token %}
        <input type="hidden" name="form_type" value="user_profile">
        <div class="profile-header">
            <div class="profile-picture-container">
                <div class="profile-picture-wrapper">
                    {% if user.userprofile.profile_picture %}
                        <img src="{{ user.userprofile.profile_picture.url }}" alt="{% trans 'Profile Picture' %}" class="profile-picture">
                    {% else %}
                        <div class="profile-picture-placeholder">
                            <i class="fas fa-user"></i>
                        </div>
                    {% endif %}
                    <div class="profile-picture-overlay">
                        <label for="{{ user_form.profile_picture.id_for_label }}" class="profile-picture-edit">
                            <i class="fas fa-camera"></i>
                            <span>{% trans "Change Photo" %}</span>
                        </label>
                    </div>
                </div>
                {{ user_form.profile_picture }}
                {% if user_form.profile_picture.errors %}
                    <div class="invalid-feedback d-block">
                        {{ user_form.profile_picture.errors|join:", " }}
                    </div>
                {% endif %}
            </div>
            <div class="profile-info">
                <h1>{{ user.get_full_name|default:user.username }}</h1>
                <p class="text-muted">{{ user.email }}</p>
                {% if user.userprofile.role == 'employer' %}
                    <span class="badge bg-primary">{% trans "Employer" %}</span>
                {% elif user.userprofile.role == 'admin' %}
                    <span class="badge bg-danger">{% trans "Admin" %}</span>
                {% else %}
                    <span class="badge bg-success">{% trans "Job Seeker" %}</span>
                {% endif %}
            </div>
        </div>

        {% if user.userprofile.role == 'employer' %}
            <div class="employer-section mb-4">
                <h3 class="h4 mb-3">{% trans "Company Information" %}</h3>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label" for="{{ employer_form.company_name.id_for_label }}">{% trans "Company Name" %}</label>
                        {{ employer_form.company_name }}
                        {% if employer_form.company_name.errors %}
                            <div class="invalid-feedback d-block">
                                {{ employer_form.company_name.errors|join:", " }}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label" for="{{ employer_form.company_website.id_for_label }}">{% trans "Company Website" %}</label>
                        {{ employer_form.company_website }}
                        {% if employer_form.company_website.errors %}
                            <div class="invalid-feedback d-block">
                                {{ employer_form.company_website.errors|join:", " }}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label" for="{{ employer_form.company_description.id_for_label }}">{% trans "Company Description" %}</label>
                    {{ employer_form.company_description }}
                    {% if employer_form.company_description.errors %}
                        <div class="invalid-feedback d-block">
                            {{ employer_form.company_description.errors|join:", " }}
                        </div>
                    {% endif %}
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label" for="{{ employer_form.company_logo.id_for_label }}">{% trans "Company Logo" %}</label>
                        {{ employer_form.company_logo }}
                        {% if employer_form.company_logo.errors %}
                            <div class="invalid-feedback d-block">
                                {{ employer_form.company_logo.errors|join:", " }}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label" for="{{ employer_form.company_size.id_for_label }}">{% trans "Company Size" %}</label>
                        {{ employer_form.company_size }}
                        {% if employer_form.company_size.errors %}
                            <div class="invalid-feedback d-block">
                                {{ employer_form.company_size.errors|join:", " }}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label" for="{{ employer_form.industry.id_for_label }}">{% trans "Industry" %}</label>
                        {{ employer_form.industry }}
                        {% if employer_form.industry.errors %}
                            <div class="invalid-feedback d-block">
                                {{ employer_form.industry.errors|join:", " }}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label" for="{{ employer_form.location.id_for_label }}">{% trans "Location" %}</label>
                    {{ employer_form.location }}
                    {% if employer_form.location.errors %}
                        <div class="invalid-feedback d-block">
                            {{ employer_form.location.errors|join:", " }}
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="d-flex gap-2 justify-content-end mt-4">
                <button type="submit" class="btn btn-linkedin">
                    <i class="fas fa-save me-1"></i>{% trans "Save Profile" %}
                </button>
            </div>
        {% endif %}
    </form>

    {% if user.userprofile.role == 'candidate' %}
<div class="cv-card">
    <h3 class="cv-title">{% trans "Your CV" %}</h3>
    <div class="cv-actions" id="cv-actions">
        {% if user.userprofile.cv %}
            <a href="{{ user.userprofile.cv.url }}" target="_blank" class="btn btn-cv-view">
                <i class="fas fa-file-alt me-1"></i>{% trans "View Current CV" %}
            </a>
            <button type="button" class="btn-cv-remove" id="remove-cv-btn" aria-label="{% trans 'Remove CV' %}">
                    <i class="fas fa-times"></i>
                </button>
        {% endif %}
    </div>

    <div id="cv-upload-form" class="cv-upload-form" style="display: {% if user_form.cv.errors or user_form.cv_consent.errors or user_form.cv_share_with_employers.errors %}block{% else %}none{% endif %};">
        <form method="post" enctype="multipart/form-data" class="needs-validation" id="cv-upload-form-element" novalidate>
            {% csrf_token %}
            <input type="hidden" name="form_type" value="user_profile">
            <div class="mb-3">
                <label class="form-label" for="{{ user_form.cv.id_for_label }}">{% trans "Upload CV" %}</label>
                {{ user_form.cv }}
                {% if user_form.cv.help_text %}<div class="form-text">{% trans user_form.cv.help_text %}</div>{% endif %}
                {% if user_form.cv.errors %}
                    <div class="invalid-feedback d-block">{{ user_form.cv.errors|join:", " }}</div>
                {% endif %}
            </div>
            <div id="cv-form-error" class="invalid-feedback d-block" style="display: none;"></div>
            <div class="d-flex gap-2 justify-content-end">
                <button type="submit" class="btn btn-linkedin">
                    <i class="fas fa-save me-1"></i>{% trans "Save" %}
                </button>
                <button type="button" id="cancel-cv-form-btn" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-1"></i>{% trans "Cancel" %}
                </button>
            </div>
        </form>
    </div>
    {% if not user.userprofile.cv %}
        <button id="show-cv-form-btn" type="button" class="btn btn-cv-upload">
            <i class="fas fa-upload me-1"></i>{% trans "Add/Upload CV" %}
        </button>
    {% endif %}
    </div>

    <!-- Recent Applications Section -->
    <div class="applications-section mt-4">
        <h3 class="h4 mb-3">{% trans "Your Job Applications" %}</h3>
        {% if applications %}
        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>{% trans "Position" %}</th>
                                <th>{% trans "Company" %}</th>
                                <th>{% trans "Applied On" %}</th>
                                <th>{% trans "Status" %}</th>
                                <th class="text-center">{% trans "Action" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for application in applications %}
                            <tr>
                                <td>{{ application.job.title }}</td>
                                <td>{{ application.job.company }}</td>
                                <td>{{ application.applied_at|date:"d M Y" }}</td>
                                <td>
                                    {% if application.status == 'განხილვის_პროცესში' %}
                                    <span class="badge bg-secondary">{% trans "განხილვის პროცესში" %}</span>
                                    {% elif application.status == 'გასაუბრება' %}
                                    <span class="badge bg-success">{% trans "გასაუბრება" %}</span>
                                    {% elif application.status == 'რეზერვი' %}
                                    <span class="badge bg-warning text-dark">{% trans "რეზერვი" %}</span>
                                    {% elif application.status == 'pending' %}
                                    <span class="badge bg-secondary">{% trans "Pending" %}</span>
                                    {% elif application.status == 'reviewed' %}
                                    <span class="badge bg-info">{% trans "Reviewed" %}</span>
                                    {% elif application.status == 'interviewed' %}
                                    <span class="badge bg-primary">{% trans "Interviewed" %}</span>
                                    {% elif application.status == 'offered' %}
                                    <span class="badge bg-success">{% trans "Offer Extended" %}</span>
                                    {% elif application.status == 'accepted' %}
                                    <span class="badge bg-success">{% trans "Accepted" %}</span>
                                    {% elif application.status == 'rejected' %}
                                    <span class="badge bg-danger">{% trans "Rejected" %}</span>
                                    {% elif application.status == 'withdrawn' %}
                                    <span class="badge bg-secondary">{% trans "Withdrawn" %}</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <a href="{% url 'job_detail' application.job.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye me-1"></i>{% trans "View Job" %}
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="mt-3 small">
            <h5>{% trans "სტატუსების ახსნა:" %}</h5>
            <ul class="list-unstyled status-explanations">
                <li>
                    <span class="badge bg-success me-2">{% trans "გასაუბრება" %}</span>
                    {% trans "ნიშნავს რომ კომპანიამ განიხილა თქვენი კანდიდატურა, თვლის რომ შეესაბამებით პოზიციას და დაგიკავშირდებიან გასაუბრებაზე დასაბარებლად" %}
                </li>
                <li>
                    <span class="badge bg-warning text-dark me-2">{% trans "რეზერვი" %}</span>
                    {% trans "ნიშნავს, რომ კომპანიამ განიხილა თქვენი კანდიდატურა, თვლის რომ არ შეესაბამებით პოზიციას და ამ ეტაპზე ვერ აგიყვანენ, თუმცა თქვენი სივი შეინახება ბაზაში მომავალში დაინტერესების შემთვევაში დასაკონტაქტებლად" %}
                </li>
                <li>
                    <span class="badge bg-secondary me-2">{% trans "განხილვის პროცესში" %}</span>
                    {% trans "ნიშნავს რომ თქვენი კანდიდატურა ჯერ არ განუხილავთ" %}
                </li>
            </ul>
        </div>
        {% else %}
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-file-import fa-3x text-muted mb-3"></i>
                <h5>{% trans "No Applications Yet" %}</h5>
                <p class="text-muted mb-0">{% trans "You haven't applied to any jobs yet." %}</p>
                <a href="{% url 'job_list' %}" class="btn btn-outline-primary mt-3">
                    <i class="fas fa-search me-1"></i>{% trans "Browse Job Listings" %}
                </a>
            </div>
        </div>
    {% endif %}
</div>
{% endif %}
</div>

<style>
.profile-picture-container {
    position: relative;
    width: 152px;
    height: 152px;
    margin-right: 24px;
}

.profile-picture-wrapper {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    overflow: hidden;
    position: relative;
    background-color: var(--linkedin-light-gray);
}

.profile-picture {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.profile-picture-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    color: var(--linkedin-gray);
}

.profile-picture-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0,0,0,0.6);
    padding: 8px;
    opacity: 0;
    transition: opacity 0.2s;
}

.profile-picture-container:hover .profile-picture-overlay {
    opacity: 1;
}

.profile-picture-edit {
    color: white;
    text-align: center;
    display: block;
    cursor: pointer;
    font-size: 0.9rem;
}

.profile-picture-edit i {
    display: block;
    font-size: 1.2rem;
    margin-bottom: 4px;
}

#id_profile_picture {
    display: none;
}

.employer-section {
    background-color: var(--linkedin-light-blue);
    padding: 20px;
    border-radius: 8px;
    margin-top: 24px;
}

.cv-card {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    padding: 32px 24px;
    max-width: 420px;
    margin: 32px auto;
    text-align: center;
}
.cv-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 24px;
}
.cv-actions {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
}
.btn-cv-view {
    background: #f5faff;
    color: #0073b1;
    border: 1px solid #0073b1;
    border-radius: 8px;
    padding: 8px 18px;
    font-weight: 500;
    transition: background 0.2s, color 0.2s;
}
.btn-cv-view:hover {
    background: #0073b1;
    color: #fff;
}
.btn-cv-remove {
    background: none;
    border: none;
    color: #dc3545;
    font-size: 1.7rem;
    cursor: pointer;
    transition: color 0.2s;
    margin-left: 8px;
}
.btn-cv-remove:hover {
    color: #a71d2a;
    transform: scale(1.15);
}
.btn-cv-upload {
    background: #0073b1;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 10px 28px;
    font-size: 1.1rem;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    transition: background 0.2s;
}
.btn-cv-upload:hover {
    background: #005983;
}
.cv-upload-form {
    margin-top: 24px;
    text-align: left;
    background: #f8fafd;
    border-radius: 12px;
    padding: 24px 18px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.03);
    animation: fadeIn 0.3s;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(16px);}
    to { opacity: 1; transform: none;}
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Form validation
    (function () {
        'use strict'
        var forms = document.querySelectorAll('.needs-validation')
        Array.prototype.slice.call(forms).forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
        })
    })()

    // Profile picture preview
    document.getElementById('id_profile_picture').addEventListener('change', function(e) {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const container = document.querySelector('.profile-picture-wrapper');
                container.innerHTML = `
                    <img src="${e.target.result}" alt="Profile Picture" class="profile-picture">
                    <div class="profile-picture-overlay">
                        <label for="id_profile_picture" class="profile-picture-edit">
                            <i class="fas fa-camera"></i>
                            <span>{% trans "Change Photo" %}</span>
                        </label>
                    </div>
                `
            }
        }
    })

    document.addEventListener('DOMContentLoaded', function() {
        // Show CV upload form
        const showCvFormBtn = document.getElementById('show-cv-form-btn');
        const cvUploadForm = document.getElementById('cv-upload-form');
        const cancelCvFormBtn = document.getElementById('cancel-cv-form-btn');
        const cvUploadFormElement = document.getElementById('cv-upload-form-element');
        const removeCvBtn = document.getElementById('remove-cv-btn');

        if (showCvFormBtn) {
            showCvFormBtn.addEventListener('click', function() {
                cvUploadForm.style.display = 'block';
                showCvFormBtn.style.display = 'none';
            });
        }

        if (cancelCvFormBtn) {
            cancelCvFormBtn.addEventListener('click', function() {
                cvUploadForm.style.display = 'none';
                if (showCvFormBtn) {
                    showCvFormBtn.style.display = 'block';
            }
        });
    }

        // Handle CV upload form submission
        if (cvUploadFormElement) {
            cvUploadFormElement.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);

                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        const errorDiv = document.getElementById('cv-form-error');
                        errorDiv.textContent = data.error || 'An error occurred while uploading the CV.';
                        errorDiv.style.display = 'block';
                    }
                })
                .catch(error => {
                    const errorDiv = document.getElementById('cv-form-error');
                    errorDiv.textContent = 'An error occurred while uploading the CV.';
                    errorDiv.style.display = 'block';
                });
            });
        }

        // Handle CV removal
        if (removeCvBtn) {
            removeCvBtn.addEventListener('click', function() {
                if (confirm('{% trans "Are you sure you want to remove your CV?" %}')) {
                    fetch('{% url "remove_cv" %}', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            alert('{% trans "An error occurred while removing the CV." %}');
                        }
                    })
                    .catch(error => {
                        alert('{% trans "An error occurred while removing the CV." %}');
                    });
                }
            });
        }
    });
</script>
<style>
.btn-linkedin {
    background-color: #0073b1;
    border-color: #0073b1;
    color: white;
    font-weight: 600;
    padding: 12px;
    border-radius: 8px;
}
</style>
{% endblock %}